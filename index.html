<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="page-title">Nav-Tools - 导航网站</title>
    <meta
      name="description"
      content="精选优质网站导航，为您提供便捷的网站收藏和访问服务"
      id="page-description"
    />
    <meta
      name="keywords"
      content="导航网站,网站收藏,工具导航,开发工具,设计资源,学习平台"
      id="page-keywords"
    />
    <link rel="icon" href="./favicon.ico" type="image/x-icon" />

    <script src="./vendor/js/tailwind.js"></script>
    <script src="./vendor/js/lucide.js"></script>
    <link href="./vendor/css/google-fonts.css" rel="stylesheet" />
    <link href="./css/common.css" rel="stylesheet" />

    <script src="./vendor/js/Sortable.min.js"></script>

    <style>
      :root {
        --bg-color: #0d1117;
        --sidebar-bg-color: #161b22;
        --card-bg-color: rgba(22, 27, 34, 0.85);
        --border-color: rgba(139, 148, 158, 0.2);
        --text-color: #c9d1d9;
        --text-secondary-color: #8b949e;
        --accent-color: #58a6ff;
        --accent-glow: 0 0 15px rgba(88, 166, 255, 0.5),
          0 0 5px rgba(88, 166, 255, 0.8);
        --sidebar-width: 230px;
      }

      /* 通知系统样式 */
      #notification-container {
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      .notification {
        background-color: #161b22cc;
        backdrop-filter: blur(5px);
        color: #f87171; /* red-400 */
        padding: 1rem;
        border-radius: 0.5rem;
        border: 1px solid #ef4444; /* red-500 */
        box-shadow: 0 0 15px rgba(239, 68, 68, 0.3);
        cursor: pointer;
        transition: all 0.3s ease;
        opacity: 0;
        transform: translateX(100%);
        animation: slideIn 0.5s forwards;
        max-width: 300px;
        word-wrap: break-word;
      }
      .notification.success {
        color: #4ade80; /* green-400 */
        border-color: #22c55e; /* green-500 */
        box-shadow: 0 0 15px rgba(34, 197, 94, 0.3);
      }
      @keyframes slideIn {
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }
      @keyframes slideOut {
        from {
          opacity: 1;
          transform: translateX(0);
        }
        to {
          opacity: 0;
          transform: translateX(100%);
        }
      }

      html,
      body {
        scroll-behavior: smooth;
        height: 100%;
        overflow: hidden;
      }

      body {
        font-family: "Noto Sans SC", sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        background-image: radial-gradient(
          circle at 1px 1px,
          rgba(139, 148, 158, 0.1) 1px,
          transparent 0
        );
        background-size: 30px 30px;
      }

      .font-exo {
        font-family: "Exo 2", sans-serif;
      }

      .nav-card {
        background-color: var(--card-bg-color);
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        transition: box-shadow 0.25s ease-in-out, transform 0.25s ease-in-out, border-color 0.25s ease-in-out;
        position: relative;
        overflow: visible;
        backdrop-filter: blur(8px);
        cursor: grab;
        user-select: none;
        will-change: transform;
      }
      .nav-card:active {
        cursor: grabbing;
      }
      
      /* 拖拽时禁用hover效果但保留SortableJS动画 */
      .dragging-active .nav-card:hover {
        transform: none !important;
        box-shadow: none !important;
        border-color: var(--border-color) !important;
      }
      
      /* 确保拖拽项不受hover影响 */
      .dragging-item:hover {
        transform: none !important;
        box-shadow: none !important;
        border-color: var(--border-color) !important;
      }

      /* --- SortableJS 拖拽样式 --- */
      /* 占位符的样式 - 显示拖拽目标位置 */
      .drag-ghost-class {
        opacity: 0.5;
        background-color: rgba(88, 166, 255, 0.15);
        border: 2px dashed rgba(88, 166, 255, 0.6);
        transform: scale(0.98);
        transition: all 0.2s ease;
      }
      
      /* 选中准备拖拽的样式 */
      .card-chosen {
        cursor: grabbing !important;
        transform: scale(1.01);
        transition: transform 0.15s ease;
      }
      
      /* 被拖拽项的样式 */
      .card-is-dragging {
        opacity: 0.85 !important;
        transform: scale(1.05) rotate(2deg) !important;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25) !important;
        z-index: 9999 !important;
        transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94) !important;
      }
      
      /* Fallback拖拽样式 - 用于不支持HTML5拖拽的情况 */
      .drag-fallback {
        opacity: 0.8 !important;
        transform: scale(1.03) rotate(1deg) !important;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2) !important;
        z-index: 9999 !important;
        pointer-events: none !important;
      }
      

      
      .card-is-dragging .favorite-btn,
      .drag-fallback .favorite-btn {
        pointer-events: none !important;
      }
      
      /* 拖拽状态下的容器样式 */
      .dragging-active {
        position: relative;
      }
      
      /* 拖拽状态下禁用所有hover效果 */
      .dragging-active .nav-card:hover {
        border-color: var(--border-color) !important;
        box-shadow: none !important;
        transform: none !important;
      }
      
      .dragging-item {
        user-select: none !important;
      }
      
      .dragging-item .favorite-btn {
        pointer-events: none !important;
      }
      /* --- 结束拖拽样式 --- */

      .nav-card:hover {
        border-color: rgba(88, 166, 255, 0.5);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2), var(--accent-glow);
        transform: translateY(-5px) scale(1.02);
      }

      .nav-card:hover .nav-card-logo {
        filter: drop-shadow(0 0 5px var(--accent-color));
      }

      .search-input {
        background-color: var(--card-bg-color);
        border: 1px solid var(--border-color);
        color: var(--text-color);
        transition: all 0.3s ease;
      }
      .search-input:focus {
        outline: none;
        border-color: var(--accent-color);
        box-shadow: var(--accent-glow);
      }
      .nav-card-logo {
        transition: all 0.3s ease;
      }
      .category-title {
        color: var(--text-color);
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--border-color);
        text-shadow: 0 0 8px rgba(88, 166, 255, 0.3);
      }
      .sidebar {
        background-color: var(--sidebar-bg-color);
        border-right: 1px solid var(--border-color);
        transition: transform 0.3s ease-in-out;
      }
      .sidebar-link {
        transition: all 0.2s ease;
        color: var(--text-secondary-color);
        font-size: 1rem;
        font-weight: 500;
        font-family: "Exo 2", sans-serif;
      }
      .sidebar-link:hover,
      .sidebar-link.active {
        color: var(--text-color);
        background-color: rgba(88, 166, 255, 0.1);
        transform: translateX(5px);
      }
      .sidebar-link.active {
        border-left-color: var(--accent-color);
      }
      .sidebar-link i {
        width: 18px;
        height: 18px;
      }
      #home-page-container {
        height: 100vh;
        overflow-y: auto;
        padding-bottom: 35vh;
      }
      .favorite-btn {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        z-index: 10;
        color: var(--text-secondary-color);
        padding: 0.25rem;
        border-radius: 99px;
        transition: all 0.2s ease-in-out;
      }
      .favorite-btn:hover {
        color: #facc15;
        background-color: rgba(250, 204, 21, 0.1);
      }
      .favorite-btn.favorited svg {
        fill: #facc15;
        color: #facc15;
      }
      .favorite-btn svg {
        transition: all 0.2s ease;
      }
      .modal-overlay {
        transition: opacity 0.3s ease-in-out;
      }
      .modal-container {
        transition: all 0.3s ease-in-out;
      }
      .modal-hidden {
        opacity: 0;
        pointer-events: none;
      }
      .modal-hidden .modal-container {
        transform: translateY(1rem) scale(0.98);
      }
      .segmented-control {
        display: flex;
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 0.5rem;
        padding: 0.25rem;
        border: 1px solid var(--border-color);
      }
      .segmented-control input[type="radio"] {
        display: none;
      }
      .segmented-control label {
        flex: 1;
        text-align: center;
        padding: 0.625rem 0.5rem;
        border-radius: 0.375rem;
        color: var(--text-secondary-color);
        font-weight: 500;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
      }
      .segmented-control label:hover {
        background-color: rgba(255, 255, 255, 0.05);
        color: var(--text-color);
      }
      .segmented-control input[type="radio"]:checked + label {
        background-color: var(--accent-color);
        color: var(--bg-color);
        box-shadow: var(--accent-glow);
        transform: scale(1.02);
      }
      .nav-card-logo img {
        width: 50px;
        height: 50px;
        object-fit: contain;
        border-radius: 8px;
      }

      /* 导航卡片描述样式 - 限制两行显示 */
      .nav-card-desc {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.4;
        max-height: calc(1.4em * 2);
      }

      /* 二级导航样式 */
      .primary-nav-item {
        margin-bottom: 0.5rem;
      }
      
      .primary-link {
        background-color: transparent;
        border: none;
        color: var(--text-color);
        transition: all 0.2s ease-in-out;
      }
      
      .primary-link:hover {
        background-color: rgba(255, 255, 255, 0.05);
        color: var(--accent-color);
      }
      
      /* 主分类高亮样式 */
      .primary-link.primary-active {
        background-color: rgba(59, 130, 246, 0.1);
        color: var(--accent-color);
        border-left-color: var(--accent-color);
      }
      
      .secondary-nav {
        transition: all 0.3s ease-in-out;
      }
      
      .secondary-link {
        color: var(--text-secondary-color);
        font-size: 0.875rem;
        transition: all 0.2s ease-in-out;
        border-left: 2px solid transparent;
      }
      
      .secondary-link:hover {
        background-color: rgba(255, 255, 255, 0.05);
        color: var(--text-color);
        border-left-color: var(--accent-color);
      }
      
      /* 二级导航高亮样式 */
      .secondary-link.active {
        background-color: rgba(59, 130, 246, 0.15);
        color: var(--accent-color);
        border-left-color: var(--accent-color);
      }
      
      .sub-category-title {
        position: relative;
        padding-left: 1rem;
      }
      
      .sub-category-title::before {
        content: '';
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 4px;
        height: 20px;
        background: linear-gradient(135deg, var(--accent-color), #06b6d4);
        border-radius: 2px;
      }
      
      /* 开关样式 */
      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 44px;
        height: 24px;
      }
      
      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      
      .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #4b5563;
        transition: 0.3s;
        border-radius: 24px;
      }
      
      .toggle-slider:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 2px;
        bottom: 2px;
        background-color: white;
        transition: 0.3s;
        border-radius: 50%;
      }
      
      .toggle-switch input:checked + .toggle-slider {
        background-color: #3b82f6;
      }
      
      .toggle-switch input:checked + .toggle-slider:before {
        transform: translateX(20px);
      }
      
      /* 搜索框吸顶样式 */
      .search-container {
        transition: all 0.3s ease;
      }
      
      .search-container.sticky {
        position: sticky;
        top: 0;
        z-index: 30;
        background-color: var(--bg-color);
        backdrop-filter: blur(10px);
        /* border-bottom: 1px solid var(--border-color); */
        padding-top: 1rem;
        padding-bottom: 1rem;
        margin-bottom: 0;
      }
      
      .search-container.sticky .search-input {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      }
      
      /* 全局tooltip容器 - 避免层叠上下文问题 */
      #global-tooltip-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 10000;
      }
      
      .global-tooltip {
        position: absolute;
        background: var(--card-bg-color);
        color: var(--text-color);
        padding: 12px 16px;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 600;
        font-family: "Exo 2", sans-serif;
        max-width: 280px;
        min-width: 100px;
        text-align: justify;
        text-align-last: center;
        border: 1px solid var(--border-color);
        box-shadow: 
          0 20px 40px rgba(0, 0, 0, 0.3),
          0 8px 24px rgba(0, 0, 0, 0.2),
          0 4px 12px rgba(88, 166, 255, 0.1),
          inset 0 1px 0 rgba(255, 255, 255, 0.1),
          inset 0 -1px 0 rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(16px) saturate(1.2);
        opacity: 0;
        visibility: hidden;
        transform: scale(0.85) translateY(8px);
        transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
        pointer-events: none;
        z-index: 1;
        word-wrap: break-word;
        line-height: 1.5;
        letter-spacing: 0.025em;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        position: relative;
        overflow: hidden;
      }
      
      /* 添加微妙的光泽效果 */
      .global-tooltip::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, 
          transparent, 
          rgba(88, 166, 255, 0.1), 
          transparent);
        transition: left 0.6s ease;
        pointer-events: none;
      }
      
      .global-tooltip.show {
        opacity: 1;
        visibility: visible;
        transform: scale(1) translateY(0);
      }
      
      /* 显示时触发光泽动画 */
      .global-tooltip.show::before {
        left: 100%;
      }
      
      .global-tooltip::after {
        content: '';
        position: absolute;
        width: 0;
        height: 0;
        border: 8px solid transparent;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
      }
      
      .global-tooltip.tooltip-top::after {
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border-top-color: var(--card-bg-color);
        border-top-width: 10px;
        border-left-width: 8px;
        border-right-width: 8px;
      }
      
      .global-tooltip.tooltip-bottom::after {
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        border-bottom-color: var(--card-bg-color);
        border-bottom-width: 10px;
        border-left-width: 8px;
        border-right-width: 8px;
      }
      
      .global-tooltip.tooltip-left::after {
        top: 50%;
        left: 100%;
        transform: translateY(-50%);
        border-left-color: var(--card-bg-color);
        border-left-width: 10px;
        border-top-width: 8px;
        border-bottom-width: 8px;
      }
      
      .global-tooltip.tooltip-right::after {
        top: 50%;
        right: 100%;
        transform: translateY(-50%);
        border-right-color: var(--card-bg-color);
        border-right-width: 10px;
        border-top-width: 8px;
        border-bottom-width: 8px;
      }
    </style>
  </head>
  <body class="min-h-screen text-sm md:text-base">
    <div class="flex">
      <aside
        id="sidebar"
        class="sidebar fixed top-0 left-0 h-full w-[var(--sidebar-width)] z-40 transform -translate-x-full md:translate-x-0 flex-shrink-0"
      >
        <div class="flex flex-col h-full">
          <header class="p-6 border-b border-b-[var(--border-color)]">
            <a
              href="#"
              id="logo-link"
              class="font-exo text-2xl font-bold tracking-wider"
              ><span
                class="bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-cyan-300"
                id="sidebar-title"
                >Nav-Tools</span
              ></a
            >
            <p
              class="text-xs text-gray-500 mt-1 truncate"
              id="sidebar-description"
              title="精选网站导航"
            >
              精选网站导航
            </p>
          </header>
          <nav id="sidebarNav" class="flex-grow p-4 overflow-y-auto"></nav>
          <footer
            class="p-4 text-xs border-t border-t-[var(--border-color)] flex justify-between items-center"
          >
            <p class="text-gray-500" id="copyright-text">
              Powered by @AhYi8 ✨ &copy; 2024
            </p>
            <button
              id="settings-btn"
              class="text-gray-500 hover:text-accent-color transition-colors"
              title="设置"
            >
              <i data-lucide="settings" class="w-4 h-4"></i>
            </button>
          </footer>
        </div>
      </aside>
      <main
        id="mainContent"
        class="w-full transition-all duration-300 md:ml-[var(--sidebar-width)]"
      >
        <div id="home-page-container">
          <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12">
            <div class="md:hidden mb-6 flex items-center justify-between">
              <h1 class="font-exo text-2xl font-bold">Nav-Tools</h1>
              <button id="menu-toggle" class="p-2">
                <i data-lucide="menu" class="w-6 h-6"></i>
              </button>
            </div>
            <div id="search-container" class="search-container mb-8 md:mb-12 relative">
              <div
                class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"
              >
                <i data-lucide="search" class="w-5 h-5 text-gray-500"></i>
              </div>
              <input
                type="search"
                id="searchInput"
                placeholder="搜索网站，例如：GitHub, Google, Figma..."
                class="search-input w-full p-4 pl-12 rounded-full text-base"
              />
            </div>
            <div id="navContainer"></div>
            <div id="noResults" class="hidden text-center py-16"></div>
          </div>
        </div>
      </main>
    </div>
    <div
      id="overlay"
      class="fixed inset-0 bg-black/50 z-30 hidden md:hidden"
    ></div>
    
    <!-- 消息通知容器 -->
    <div id="notification-container"></div>
    
    <!-- 全局tooltip容器 - 避免层叠上下文问题 -->
    <div id="global-tooltip-container"></div>
    <div
      id="settings-modal"
      class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm modal-hidden"
    >
      <div
        class="modal-container bg-[var(--sidebar-bg-color)] w-full max-w-lg rounded-xl shadow-xl border border-[var(--border-color)]"
      >
        <header
          class="p-5 border-b border-[var(--border-color)] flex justify-between items-center"
        >
          <h2 class="text-lg font-bold flex items-center gap-2">
            <i data-lucide="settings-2" class="w-5 h-5 text-accent-color"></i
            ><span>系统设置</span>
          </h2>
          <button
            id="settings-close-btn"
            class="text-gray-500 hover:text-white transition-colors p-1 rounded-full"
          >
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </header>
        <main class="p-5 md:p-6 max-h-[70vh] overflow-y-auto">
          <div class="space-y-6">
            <!-- 网站卡片列数设置 -->
            <div class="flex items-center justify-between">
              <label class="font-semibold text-gray-200">网站卡片列数</label>
              <div
                id="columns-setting-group"
                class="segmented-control flex-shrink-0 w-36"
              >
                <input
                  type="radio"
                  name="columns"
                  value="2"
                  id="cols-2"
                /><label for="cols-2">2</label
                ><input
                  type="radio"
                  name="columns"
                  value="3"
                  id="cols-3"
                /><label for="cols-3">3</label
                ><input
                  type="radio"
                  name="columns"
                  value="4"
                  id="cols-4"
                /><label for="cols-4">4</label
                ><input
                  type="radio"
                  name="columns"
                  value="5"
                  id="cols-5"
                /><label for="cols-5">5</label>
              </div>
            </div>

            <!-- 显示网站LOGO设置 -->
            <div class="flex items-center justify-between">
              <label class="font-semibold text-gray-200">显示网站LOGO</label>
              <label class="toggle-switch">
                <input type="checkbox" id="show-logo-toggle">
                <span class="toggle-slider"></span>
              </label>
            </div>

            <!-- 显示二级导航图标设置 -->
            <div class="flex items-center justify-between">
              <label class="font-semibold text-gray-200">显示二级导航图标</label>
              <label class="toggle-switch">
                <input type="checkbox" id="show-subcategory-icons-toggle">
                <span class="toggle-slider"></span>
              </label>
            </div>

            <!-- 搜索框吸顶设置 -->
            <div class="flex items-center justify-between">
              <label class="font-semibold text-gray-200">搜索框吸顶</label>
              <label class="toggle-switch">
                <input type="checkbox" id="sticky-search-box-toggle">
                <span class="toggle-slider"></span>
              </label>
            </div>

          </div>
        </main>
      </div>
    </div>

    <script src="./config/nav-config.js"></script>
    <script>
      // --- 全局变量和页面加载总入口 ---
      let favorites = [];
      let allNavMap = new Map();

      // --- 通知系统 ---
      function showNotification(message, type = "error") {
        const notificationContainer = document.getElementById("notification-container");
        const notification = document.createElement("div");
        notification.className = `notification ${type}`;
        notification.textContent = message;
        notificationContainer.appendChild(notification);
        
        notification.addEventListener("click", () => {
          notification.style.animation = "slideOut 0.5s forwards";
          setTimeout(() => notification.remove(), 500);
        });
        
        setTimeout(() => {
          if (notification.parentElement) {
            notification.style.animation = "slideOut 0.5s forwards";
            setTimeout(() => notification.remove(), 500);
          }
        }, 3000);
      }

      document.addEventListener("DOMContentLoaded", () => {
        try {
          if (typeof navData === "undefined" || !navData) {
            console.error("错误：`navData` 未定义。");
            return;
          }
          applySiteConfig();
          initializeNavMap();
          loadFavorites();
          loadNavOrder();
          renderContent();
          initFunctionalJS();
          applyStickySearchBoxSetting();
          renderContent();
        } catch (error) {
          console.error("页面初始化时发生严重错误:", error);
        }
      });

      // 应用网站配置
      function applySiteConfig() {
        if (typeof siteConfig !== "undefined") {
          // 更新页面标题和meta信息
          const titleEl = document.getElementById("page-title");
          const descEl = document.getElementById("page-description");
          const keywordsEl = document.getElementById("page-keywords");
          const sidebarTitleEl = document.getElementById("sidebar-title");
          const sidebarDescEl = document.getElementById("sidebar-description");
          const copyrightEl = document.getElementById("copyright-text");

          if (titleEl) titleEl.textContent = siteConfig.title;
          if (descEl) descEl.setAttribute("content", siteConfig.description);
          if (keywordsEl)
            keywordsEl.setAttribute("content", siteConfig.keywords);
          if (sidebarTitleEl)
            sidebarTitleEl.textContent = siteConfig.sidebarHeader.title;
          if (sidebarDescEl) {
            sidebarDescEl.textContent = siteConfig.sidebarHeader.description;
            sidebarDescEl.setAttribute(
              "title",
              siteConfig.sidebarHeader.description
            );
          }
          if (copyrightEl) copyrightEl.textContent = siteConfig.copyright;
        }
      }

      function initFunctionalJS() {
        initSearch();
        initSidebar();
        initScrollSpy();
        initNavigation();
        initSettingsModal();
        initDragSort();
      }

      // --- 拖拽排序核心逻辑 (SortableJS 最终版) ---
      function initDragSort() {
        const grids = document.querySelectorAll("#navContainer .grid");

        grids.forEach((grid) => {
          const section = grid.closest(".category-section");

          // 收藏类目特殊处理：只能本类目内排序，不允许跨类目拖拽
          if (section && section.id === "category-favorites") {
            new Sortable(grid, {
              group: {
                name: "favorites-only",
                put: false,
                pull: false,
              },
              animation: 300,
              easing: "cubic-bezier(0.25, 0.46, 0.45, 0.94)",
              ghostClass: "drag-ghost-class",
              dragClass: "card-is-dragging",
              chosenClass: "card-chosen",
              fallbackClass: "drag-fallback",
              fallbackOnBody: true,
              swapThreshold: 0.65,
              onStart: function (evt) {
                evt.from.classList.add('dragging-active');
                evt.item.classList.add('dragging-item');
              },
              onEnd: function (evt) {
                evt.from.classList.remove('dragging-active');
                evt.item.classList.remove('dragging-item');
                if (evt.to) evt.to.classList.remove('dragging-active');
                lucide.createIcons();
              },
            });
          } else {
            new Sortable(grid, {
              group: "shared-navs",
              animation: 300,
              easing: "cubic-bezier(0.25, 0.46, 0.45, 0.94)",
              ghostClass: "drag-ghost-class",
              dragClass: "card-is-dragging",
              chosenClass: "card-chosen",
              fallbackClass: "drag-fallback",
              fallbackOnBody: true,
              swapThreshold: 0.65,
              onStart: function (evt) {
                evt.from.classList.add('dragging-active');
                evt.item.classList.add('dragging-item');
              },
              onEnd: function (evt) {
                evt.from.classList.remove('dragging-active');
                evt.item.classList.remove('dragging-item');
                if (evt.to) evt.to.classList.remove('dragging-active');
                debouncedSaveOrder();
              },
            });
          }
        });
      }

      // --- 数据处理与持久化 ---
      function initializeNavMap() {
        for (const c in navData) {
          // 检查是否为二级导航结构
          if (typeof navData[c] === 'object' && !Array.isArray(navData[c])) {
            // 二级导航结构
            for (const subCategory in navData[c]) {
              if (Array.isArray(navData[c][subCategory])) {
                navData[c][subCategory].forEach((o) => {
                  allNavMap.set(o.title, { ...o, category: c, subCategory: subCategory });
                });
              }
            }
          } else if (Array.isArray(navData[c])) {
            // 一级导航结构（兼容旧版本）
            navData[c].forEach((o) => {
              allNavMap.set(o.title, { ...o, category: c });
            });
          }
        }
      }

      // 防抖函数
      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }
      
      // 使用防抖的保存函数
      const debouncedSaveOrder = debounce(() => {
        updateAndSaveOrder();
      }, 300);
      
      function updateAndSaveOrder() {
        const categorySections = document.querySelectorAll(
          "#navContainer .category-section:not(#category-favorites)"
        );
        const newNavData = {};
        
        // 初始化 newNavData 结构
        Object.keys(navData).forEach((cat) => {
          if (typeof navData[cat] === 'object' && !Array.isArray(navData[cat])) {
            // 二级导航结构
            newNavData[cat] = {};
            Object.keys(navData[cat]).forEach((subCat) => {
              newNavData[cat][subCat] = [];
            });
          } else {
            // 一级导航结构
            newNavData[cat] = [];
          }
        });

        categorySections.forEach((section) => {
          const categoryName = section.dataset.categoryName;
          const subCategoryName = section.dataset.subCategoryName;
          const cards = section.querySelectorAll(".nav-card");
          
          cards.forEach((card) => {
            const navTitle = card.dataset.navId;
            const nav = allNavMap.get(navTitle);
            if (nav) {
              nav.category = categoryName;
              if (subCategoryName) {
                nav.subCategory = subCategoryName;
                if (!newNavData[categoryName]) {
                  newNavData[categoryName] = {};
                }
                if (!newNavData[categoryName][subCategoryName]) {
                  newNavData[categoryName][subCategoryName] = [];
                }
                newNavData[categoryName][subCategoryName].push(nav);
              } else {
                // 一级导航
                if (!Array.isArray(newNavData[categoryName])) {
                  newNavData[categoryName] = [];
                }
                newNavData[categoryName].push(nav);
              }
            }
          });
        });
        
        navData = newNavData;
        saveNavOrder();
      }

      function loadNavOrder() {
        try {
          const c = JSON.parse(localStorage.getItem("nav-tools-order")) || {},
            o = new Set(allNavMap.keys());
          
          for (const e in c) {
            if (navData[e]) {
              if (typeof navData[e] === 'object' && !Array.isArray(navData[e])) {
                // 二级导航结构
                if (typeof c[e] === 'object' && !Array.isArray(c[e])) {
                  for (const subCat in c[e]) {
                    if (navData[e][subCat] && Array.isArray(c[e][subCat])) {
                      navData[e][subCat] = c[e][subCat]
                        .map((title) => {
                          o.delete(title);
                          return allNavMap.get(title);
                        })
                        .filter(Boolean);
                    }
                  }
                }
              } else if (Array.isArray(navData[e]) && Array.isArray(c[e])) {
                // 一级导航结构
                navData[e] = c[e]
                  .map((title) => {
                    o.delete(title);
                    return allNavMap.get(title);
                  })
                  .filter(Boolean);
              }
            }
          }
          
          // 处理未保存顺序的导航项
          o.forEach((title) => {
            const nav = allNavMap.get(title);
            if (nav) {
              const category = nav.category;
              const subCategory = nav.subCategory;
              
              if (subCategory && navData[category] && navData[category][subCategory]) {
                // 二级导航
                if (!navData[category][subCategory].some((item) => item.title === nav.title)) {
                  navData[category][subCategory].push(nav);
                }
              } else if (!subCategory && navData[category] && Array.isArray(navData[category])) {
                // 一级导航
                if (!navData[category].some((item) => item.title === nav.title)) {
                  navData[category].push(nav);
                }
              }
            }
          });
        } catch (c) {
          console.error("加载导航顺序失败, 可能由于本地存储数据格式错误:", c);
        }
      }

      function saveNavOrder() {
        const c = {};
        for (const category in navData) {
          if (typeof navData[category] === 'object' && !Array.isArray(navData[category])) {
            // 二级导航结构
            c[category] = {};
            for (const subCategory in navData[category]) {
              if (Array.isArray(navData[category][subCategory])) {
                c[category][subCategory] = navData[category][subCategory].map((item) => item.title);
              }
            }
          } else if (Array.isArray(navData[category])) {
            // 一级导航结构
            c[category] = navData[category].map((item) => item.title);
          }
        }
        localStorage.setItem("nav-tools-order", JSON.stringify(c));
      }

      // --- 渲染及其他功能 ---
      let isRenderingContent = false;
      function renderContent() {
        if (isRenderingContent) {
          console.warn("renderContent already in progress, skipping to prevent infinite loop");
          return;
        }
        
        isRenderingContent = true;
        
        try {
          const c = document.getElementById("navContainer"),
            o = document.getElementById("sidebarNav");
          (c.innerHTML = ""), (o.innerHTML = "");
          const e = document.createElement("a");
        (e.href = "#category-favorites"),
          (e.id = "favorites-link"),
          (e.className =
            "sidebar-link flex items-center py-2 px-4 rounded-md mb-1 font-medium border-l-2 border-l-transparent"),
          (e.innerHTML =
            '<i data-lucide="star" class="mr-3 flex-shrink-0"></i> 收藏'),
          o.appendChild(e);
        const t = document.createElement("hr");
        (t.className = "border-t border-t-[var(--border-color)] my-2"),
          (t.id = "favorites-divider"),
          o.appendChild(t),
          renderFavoritesSection();
        
        // 渲染主导航和二级导航
        for (const d in navData) {
          // 检查是否为二级导航结构
          const isSecondaryNav = typeof navData[d] === 'object' && !Array.isArray(navData[d]);
          
          if (isSecondaryNav) {
            // 渲染主类目
            const primaryNav = document.createElement("div");
            primaryNav.className = "primary-nav-item mb-2";
            
            const primaryLink = document.createElement("button");
            primaryLink.className = "sidebar-link primary-link flex items-center justify-between w-full py-2 px-4 rounded-md mb-1 font-medium border-l-2 border-l-transparent text-left";
            primaryLink.dataset.category = d;
            
            const iconName = (typeof categoryIcons !== "undefined" && categoryIcons[d]) ? categoryIcons[d] : "folder";
            primaryLink.innerHTML = `
              <span class="flex items-center">
                <i data-lucide="${iconName}" class="mr-3 flex-shrink-0"></i> ${d}
              </span>
              <i data-lucide="chevron-down" class="w-4 h-4 transition-transform duration-200"></i>
            `;
            
            // 二级导航容器
            const secondaryNav = document.createElement("div");
            secondaryNav.className = "secondary-nav ml-6 mt-1 space-y-1 hidden";
            secondaryNav.dataset.parentCategory = d;
            
            // 渲染二级导航项
            for (const subCategory in navData[d]) {
              const subLink = document.createElement("a");
              subLink.href = `#category-${d}-${subCategory}`;
              subLink.className = "sidebar-link secondary-link flex items-center py-1.5 px-3 rounded-md text-sm font-medium border-l-2 border-l-transparent";
              
              // 根据设置决定是否显示二级导航图标
              const showSubCategoryIcons = getShowSubCategoryIconsSetting();
              if (showSubCategoryIcons) {
                const subIconName = (typeof subCategoryIcons !== "undefined" && subCategoryIcons[d] && subCategoryIcons[d][subCategory]) 
                  ? subCategoryIcons[d][subCategory] : "circle";
                subLink.innerHTML = `<i data-lucide="${subIconName}" class="mr-2 flex-shrink-0 w-3 h-3"></i> ${subCategory}`;
              } else {
                subLink.innerHTML = `<span class="mr-2 flex-shrink-0 w-3 h-3"></span> ${subCategory}`;
              }
              
              secondaryNav.appendChild(subLink);
            }
            
            // 添加点击事件切换展开/收起
            primaryLink.addEventListener('click', () => {
              const chevron = primaryLink.querySelector('[data-lucide="chevron-down"]');
              const isExpanded = !secondaryNav.classList.contains('hidden');
              
              if (isExpanded) {
                secondaryNav.classList.add('hidden');
                chevron.style.transform = 'rotate(0deg)';
              } else {
                secondaryNav.classList.remove('hidden');
                chevron.style.transform = 'rotate(180deg)';
              }
            });
            
            primaryNav.appendChild(primaryLink);
            primaryNav.appendChild(secondaryNav);
            o.appendChild(primaryNav);
            
            // 渲染内容区域 - 优化：一级导航标题只渲染一次
            let isFirstSubCategory = true;
            for (const subCategory in navData[d]) {
              const l = document.createElement("section");
              l.id = `category-${d}-${subCategory}`;
              l.dataset.categoryName = d;
              l.dataset.subCategoryName = subCategory;
              l.className = "category-section mb-12";
              
              // 只在第一个子分类前渲染主分类标题
              if (isFirstSubCategory) {
                const a = document.createElement("h2");
                a.className = "category-title font-exo text-3xl font-bold mb-2";
                a.textContent = d;
                l.appendChild(a);
                isFirstSubCategory = false;
              }
              
              const subTitle = document.createElement("h3");
              subTitle.className = "sub-category-title font-exo text-xl font-semibold mb-6 text-gray-300";
              subTitle.textContent = subCategory;
              l.appendChild(subTitle);
              
              const r = document.createElement("div");
              r.className = getGridClassString();
              
              if (navData[d][subCategory] && Array.isArray(navData[d][subCategory])) {
                navData[d][subCategory].forEach((navItem) => {
                  r.appendChild(createNavCard(navItem));
                });
              }
              
              l.appendChild(r);
              c.appendChild(l);
            }
          } else {
            // 兼容旧的一级导航结构
            const n = document.createElement("a");
            n.href = `#category-${d}`;
            n.className = "sidebar-link flex items-center py-2 px-4 rounded-md mb-1 font-medium border-l-2 border-l-transparent";

            const iconName = (typeof categoryIcons !== "undefined" && categoryIcons[d]) ? categoryIcons[d] : "folder";
            n.innerHTML = `<i data-lucide="${iconName}" class="mr-3 flex-shrink-0"></i> ${d}`;

            o.appendChild(n);
            const l = document.createElement("section");
            l.id = `category-${d}`;
            l.dataset.categoryName = d;
            l.className = "category-section mb-12";
            
            const a = document.createElement("h2");
            a.className = "category-title font-exo text-3xl font-bold mb-8";
            a.textContent = d;
            l.appendChild(a);
            
            const r = document.createElement("div");
            r.className = getGridClassString();
            
            if (navData[d] && Array.isArray(navData[d])) {
              navData[d].forEach((navItem) => {
                r.appendChild(createNavCard(navItem));
              });
            }
            
            l.appendChild(r);
            c.appendChild(l);
          }
        }
        
        lucide.createIcons();
        } finally {
          isRenderingContent = false;
          // DOM重新渲染后，重新初始化ScrollSpy和拖拽排序功能
          setTimeout(() => {
            initScrollSpy();
            initDragSort();
          }, 100);
        }
      }

      // 防抖工具函数
      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      function createNavCard(c) {
        const o = document.createElement("div");
        (o.className = "nav-card group flex space-x-4 py-6 pr-6"),
          (o.dataset.name = c.title.toLowerCase()),
          (o.dataset.navId = c.title),
          (o.dataset.keywords = (c.keywords + " " + c.title).toLowerCase()),
          o.addEventListener("click", (o) => {
            if (o.target.closest(".favorite-btn")) return;
            window.open(c.url, "_blank");
          });

        const e = document.createElement("button");
        (e.className = "favorite-btn"),
          favorites.includes(c.title) && e.classList.add("favorited"),
          (e.innerHTML = '<i data-lucide="star" class="w-4 h-4"></i>'),
          e.addEventListener("click", (o) => toggleFavorite(o, c.title)),
          o.appendChild(e);

        // 根据设置决定是否显示LOGO
        const showLogo = getShowLogoSetting();
        if (showLogo) {
          const t = document.createElement("div");
          t.className =
            "self-center flex-shrink-0 pointer-events-none nav-card-logo";

          if (c.logoUrl) {
            t.innerHTML = `<img src="${c.logoUrl}" alt="${c.title} logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" /><i data-lucide="globe" class="w-10 h-10" style="display:none; color: var(--accent-color);"></i>`;
          } else {
            // 如果没有提供 logoUrl，尝试自动获取网站 favicon
            const domain = new URL(c.url).hostname;
            t.innerHTML = `<img src="https://www.google.com/s2/favicons?domain=${domain}&sz=64" alt="${c.title} logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" /><i data-lucide="globe" class="w-10 h-10" style="display:none; color: var(--accent-color);"></i>`;
          }
          o.appendChild(t);
        }

        const d = document.createElement("div");
        (d.className = "text-left self-start pointer-events-none"),
          (d.innerHTML = `<h3 class="font-bold text-lg text-gray-100 line-clamp-1">${c.title}</h3><p class="text-sm text-gray-400 line-clamp-2 nav-card-desc">${c.desc}</p>`),
          o.appendChild(d);

        // 全局tooltip管理器
        const globalTooltipContainer = document.getElementById('global-tooltip-container');
        let globalTooltip = null;
        let positionTimeout = null;

        // 获取吸顶搜索框的实际占用高度
        function getStickySearchBoxHeight() {
          const searchContainer = document.getElementById('search-container');
          if (searchContainer && searchContainer.classList.contains('sticky')) {
            const rect = searchContainer.getBoundingClientRect();
            return rect.height;
          }
          return 0;
        }

        // 智能tooltip位置计算 - 考虑吸顶搜索框，确保垂直居中
        function calculateGlobalTooltipPosition(cardElement, tooltipElement) {
          const cardRect = cardElement.getBoundingClientRect();
          const tooltipRect = tooltipElement.getBoundingClientRect();
          const viewportWidth = window.innerWidth;
          const viewportHeight = window.innerHeight;
          const stickyHeight = getStickySearchBoxHeight();
          
          // 可用空间计算（考虑吸顶搜索框）
          const availableTop = cardRect.top - stickyHeight;
          const availableBottom = viewportHeight - cardRect.bottom;
          const availableLeft = cardRect.left;
          const availableRight = viewportWidth - cardRect.right;
          
          const tooltipWidth = Math.max(tooltipRect.width, 80);
          const tooltipHeight = Math.max(tooltipRect.height, 40);
          const margin = 8;
          
          let position = 'top';
          let x = 0;
          let y = 0;
          
          // 优先级：上 > 下 > 左 > 右
          if (availableTop >= tooltipHeight + margin) {
            position = 'top';
            x = cardRect.left + cardRect.width / 2 - tooltipWidth / 2;
            y = cardRect.top - tooltipHeight - margin;
          } else if (availableBottom >= tooltipHeight + margin) {
            position = 'bottom';
            x = cardRect.left + cardRect.width / 2 - tooltipWidth / 2;
            y = cardRect.bottom + margin;
          } else if (availableLeft >= tooltipWidth + margin) {
            position = 'left';
            x = cardRect.left - tooltipWidth - margin;
            // 确保与卡片垂直居中
            y = cardRect.top + cardRect.height / 2 - tooltipHeight / 2;
          } else if (availableRight >= tooltipWidth + margin) {
            position = 'right';
            x = cardRect.right + margin;
            // 确保与卡片垂直居中
            y = cardRect.top + cardRect.height / 2 - tooltipHeight / 2;
          } else {
            // 空间不足时选择最大空间方向
            const maxSpace = Math.max(availableTop, availableBottom, availableLeft, availableRight);
            if (maxSpace === availableTop) {
              position = 'top';
              x = cardRect.left + cardRect.width / 2 - tooltipWidth / 2;
              y = Math.max(stickyHeight + margin, cardRect.top - tooltipHeight - margin);
            } else if (maxSpace === availableBottom) {
              position = 'bottom';
              x = cardRect.left + cardRect.width / 2 - tooltipWidth / 2;
              y = Math.min(viewportHeight - tooltipHeight - margin, cardRect.bottom + margin);
            } else if (maxSpace === availableLeft) {
              position = 'left';
              x = Math.max(margin, cardRect.left - tooltipWidth - margin);
              // 确保与卡片垂直居中，但考虑边界约束
              y = cardRect.top + cardRect.height / 2 - tooltipHeight / 2;
            } else {
              position = 'right';
              x = Math.min(viewportWidth - tooltipWidth - margin, cardRect.right + margin);
              // 确保与卡片垂直居中，但考虑边界约束
              y = cardRect.top + cardRect.height / 2 - tooltipHeight / 2;
            }
          }
          
          // 边界约束
          x = Math.max(margin, Math.min(viewportWidth - tooltipWidth - margin, x));
          
          // 对于左右位置的tooltip，确保垂直居中但不超出视口边界
          if (position === 'left' || position === 'right') {
            // 优先保持垂直居中，但确保不超出边界
            const centeredY = cardRect.top + cardRect.height / 2 - tooltipHeight / 2;
            y = Math.max(stickyHeight + margin, Math.min(viewportHeight - tooltipHeight - margin, centeredY));
          } else {
            // 上下位置的tooltip正常约束
            y = Math.max(stickyHeight + margin, Math.min(viewportHeight - tooltipHeight - margin, y));
          }
          
          return { position, x, y };
        }

        // 显示全局tooltip
        function showGlobalTooltip() {
          // 检查是否在拖拽状态
          if (document.querySelector('.dragging-active, .dragging-item, .card-is-dragging, .card-chosen')) {
            return;
          }

          // 创建全局tooltip
          if (globalTooltip) {
            globalTooltip.remove();
          }
          
          globalTooltip = document.createElement('div');
          globalTooltip.className = 'global-tooltip';
          globalTooltip.innerHTML = `<h3 class="font-bold text-lg text-gray-100">${c.title}</h3><p class="text-sm text-gray-400">${c.desc}</p>`;
          globalTooltip.style.visibility = 'hidden';
          globalTooltipContainer.appendChild(globalTooltip);

          // 初始位置计算（可能不准），并为精确校准做准备
          requestAnimationFrame(() => {
            // 先进行一次初步定位
            const initialPos = calculateGlobalTooltipPosition(o, globalTooltip);
            globalTooltip.className = `global-tooltip tooltip-${initialPos.position}`;
            globalTooltip.style.left = `${initialPos.x}px`;
            globalTooltip.style.top = `${initialPos.y}px`;

            // 关键：监听动画结束事件，然后进行最终的位置校准
            globalTooltip.addEventListener('transitionend', function onTransitionEnd() {
              // 重新计算最精确的位置
              const finalPos = calculateGlobalTooltipPosition(o, globalTooltip);
              globalTooltip.className = `global-tooltip tooltip-${finalPos.position} show`; // 保持show类
              globalTooltip.style.left = `${finalPos.x}px`;
              globalTooltip.style.top = `${finalPos.y}px`;
              globalTooltip.style.visibility = 'visible';
            }, { once: true }); // { once: true } 确保监听器执行一次后自动移除
            // 通过添加 'show' 类来触发CSS动画
            requestAnimationFrame(() => {
              globalTooltip.classList.add('show');
            });
          });
        }

        // 隐藏全局tooltip
        function hideGlobalTooltip() {
          if (globalTooltip) {
            globalTooltip.classList.remove('show');
            setTimeout(() => {
              if (globalTooltip) {
                globalTooltip.remove();
                globalTooltip = null;
              }
            }, 200);
          }
        }

        // 防抖的位置更新函数
        const debouncedPositionUpdate = debounce(() => {
          if (globalTooltip && globalTooltip.classList.contains('show')) {
            const { position, x, y } = calculateGlobalTooltipPosition(o, globalTooltip);
            globalTooltip.className = `global-tooltip tooltip-${position} show`;
            globalTooltip.style.left = `${x}px`;
            globalTooltip.style.top = `${y}px`;
          }
        }, 16);

        // 添加鼠标悬停事件
        o.addEventListener("mouseenter", () => {
          clearTimeout(positionTimeout);
          positionTimeout = setTimeout(showGlobalTooltip, 100);
        });
        
        // 添加鼠标离开事件
        o.addEventListener("mouseleave", () => {
          clearTimeout(positionTimeout);
          hideGlobalTooltip();
        });

        // 监听滚动和窗口大小变化
        const updateEvents = ['scroll', 'resize'];
        updateEvents.forEach(event => {
          window.addEventListener(event, debouncedPositionUpdate, { passive: true });
        });

        // 监听容器滚动
        const homeContainer = document.getElementById('home-page-container');
        if (homeContainer) {
          homeContainer.addEventListener('scroll', debouncedPositionUpdate, { passive: true });
        }

        return o;
      }

      function getColumnCount() {
        let c = 4;
        "undefined" != typeof siteConfig &&
          siteConfig.styleConfig &&
          siteConfig.styleConfig.nav_card_columns &&
          (c = siteConfig.styleConfig.nav_card_columns);
        let o = localStorage.getItem("nav-tools-columns");
        return o && (c = parseInt(o, 10)), c;
      }

      function getShowLogoSetting() {
        // 优先从localStorage读取，如果没有则从配置文件读取默认值
        let stored = localStorage.getItem("nav-tools-show-logo");
        if (stored !== null) {
          return stored === "true";
        }
        // 从配置文件读取默认值
        if (typeof siteConfig !== "undefined" && siteConfig.styleConfig && siteConfig.styleConfig.showLogo !== undefined) {
          return siteConfig.styleConfig.showLogo;
        }
        return true; // 默认显示
      }

      function getShowSubCategoryIconsSetting() {
        // 优先从localStorage读取，如果没有则从配置文件读取默认值
        let stored = localStorage.getItem("nav-tools-show-subcategory-icons");
        if (stored !== null) {
          return stored === "true";
        }
        // 从配置文件读取默认值
        if (typeof siteConfig !== "undefined" && siteConfig.styleConfig && siteConfig.styleConfig.showSubCategoryIcons !== undefined) {
          return siteConfig.styleConfig.showSubCategoryIcons;
        }
        return true; // 默认显示
      }

      function getStickySearchBoxSetting() {
        // 优先从localStorage读取，如果没有则从配置文件读取默认值
        let stored = localStorage.getItem("nav-tools-sticky-search-box");
        if (stored !== null) {
          return stored === "true";
        }
        // 从配置文件读取默认值
        if (typeof siteConfig !== "undefined" && siteConfig.styleConfig && siteConfig.styleConfig.stickySearchBox !== undefined) {
          return siteConfig.styleConfig.stickySearchBox;
        }
        return true; // 默认启用
      }

      function applyStickySearchBoxSetting() {
        const searchContainer = document.getElementById("search-container");
        const stickyEnabled = getStickySearchBoxSetting();
        
        if (searchContainer) {
          if (stickyEnabled) {
            searchContainer.classList.add("sticky");
          } else {
            searchContainer.classList.remove("sticky");
          }
        }
      }

      function getGridClassString() {
        let c = getColumnCount(),
          o = {
            5: "grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5",
            4: "grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4",
            3: "grid-cols-1 sm:grid-cols-2 lg:grid-cols-3",
            2: "grid-cols-1 sm:grid-cols-2",
            1: "grid-cols-1",
          };
        return `grid ${o[c] || o[4]} gap-6`;
      }

      function initSettingsModal() {
        let c = document.getElementById("settings-btn"),
          o = document.getElementById("settings-modal"),
          e = document.getElementById("settings-close-btn"),
          t = document.getElementById("columns-setting-group"),
          l = document.getElementById("show-logo-toggle"),
          s = document.getElementById("show-subcategory-icons-toggle"),
          r = document.getElementById("sticky-search-box-toggle"),
          d = () => {
            let c = getColumnCount(),
              e = document.querySelector(`input[name="columns"][value="${c}"]`);
            e && (e.checked = !0);
            
            // 设置LOGO显示开关状态
            let t = getShowLogoSetting();
            l && (l.checked = t);
            
            // 设置二级导航图标显示开关状态
            let n = getShowSubCategoryIconsSetting();
            s && (s.checked = n);
            
            // 设置搜索框吸顶开关状态
            let a = getStickySearchBoxSetting();
            r && (r.checked = a);
            
            o.classList.remove("modal-hidden"),
              lucide.createIcons();
          },
          n = () => o.classList.add("modal-hidden");
        c.addEventListener("click", d),
          e.addEventListener("click", n),
          o.addEventListener("click", (c) => {
            c.target === o && n();
          }),
          t.addEventListener("change", (c) => {
            c.target.name === "columns" &&
              (localStorage.setItem("nav-tools-columns", c.target.value),
              renderContent());
          });
        
        // LOGO显示开关事件监听
        l && l.addEventListener("change", (c) => {
          let showLogo = c.target.checked;
          localStorage.setItem("nav-tools-show-logo", showLogo);
          renderContent();
        });
        
        // 二级导航图标显示开关事件监听
        s && s.addEventListener("change", (c) => {
          let showSubCategoryIcons = c.target.checked;
          localStorage.setItem("nav-tools-show-subcategory-icons", showSubCategoryIcons);
          renderContent();
        });
        
        // 搜索框吸顶开关事件监听
        r && r.addEventListener("change", (c) => {
          let stickySearchBox = c.target.checked;
          localStorage.setItem("nav-tools-sticky-search-box", stickySearchBox);
          applyStickySearchBoxSetting();
        });
      }
      
      function loadFavorites() {
        favorites =
          JSON.parse(localStorage.getItem("nav-tools-favorites")) || [];
      }

      function saveFavorites() {
        localStorage.setItem("nav-tools-favorites", JSON.stringify(favorites));
      }

      function toggleFavorite(c, o) {
        c.stopPropagation();
        let e = favorites.indexOf(o);
        e > -1 ? favorites.splice(e, 1) : favorites.push(o),
          saveFavorites(),
          document
            .querySelectorAll(
              `.nav-card[data-nav-id="${o.replace(/"/g, '\\"')}"]`
            )
            .forEach((c) => {
              c.querySelector(".favorite-btn").classList.toggle(
                "favorited",
                favorites.includes(o)
              );
            }),
          renderFavoritesSection(),
          lucide.createIcons();
          initDragSort();
      }

      function renderFavoritesSection() {
        let c = document.getElementById("navContainer"),
          o = document.getElementById("category-favorites"),
          e = document.getElementById("favorites-link"),
          t = document.getElementById("favorites-divider"),
          d = favorites.length > 0;
        e && (e.style.display = d ? "flex" : "none"),
          t && (t.style.display = d ? "block" : "none");
        let n = () => {
          o.classList.add("favorite-section-leave"),
            setTimeout(() => {
              o.remove();
            }, 400);
        };
        if (d) {
          let e = favorites.map((c) => allNavMap.get(c)).filter(Boolean);
          if (o) o.innerHTML = "";
          else {
            (o = document.createElement("section")),
              (o.id = "category-favorites"),
              (o.className =
                "category-section mb-12 favorite-section-enter"),
              c.prepend(o);
          }
          let t = document.createElement("h2");
          (t.className =
            "category-title font-exo text-3xl font-bold mb-8 flex items-center"),
            (t.innerHTML =
              '<i data-lucide="star" class="w-7 h-7 mr-3 text-yellow-400 fill-current"></i> 收藏'),
            o.appendChild(t);
          let d = document.createElement("div");
          (d.className = getGridClassString()),
            e.forEach((c) => {
              let o = createNavCard(c);
              d.appendChild(o);
            }),
            o.appendChild(d);
        } else o && n();
      }

      function resetToAllNavView() {
        document.querySelectorAll(".nav-card").forEach((c) => {
          c.style.display = "flex";
        }),
          document.querySelectorAll(".category-section").forEach((c) => {
            c.style.display = "block";
          });
        let c = document.getElementById("category-favorites");
        c && 0 === favorites.length
          ? (c.style.display = "none")
          : c && (c.style.display = "block"),
          (document.getElementById("noResults").style.display = "none");
      }

      function initNavigation() {
        let c = document.getElementById("logo-link"),
          o = document.getElementById("sidebarNav");
        c.addEventListener("click", (c) => {
          c.preventDefault(),
            resetToAllNavView(),
            (document.getElementById("searchInput").value = ""),
            document
              .getElementById("home-page-container")
              .scrollTo({ top: 0, behavior: "smooth" });
        }),
          o.addEventListener("click", (c) => {
            let o = c.target.closest("a");
            if (!o) return;
            c.preventDefault(),
              resetToAllNavView(),
              setTimeout(() => {
                let c = o.getAttribute("href"),
                  e = document.querySelector(c);
                if (e) {
                  let c = document.getElementById("home-page-container");
                  c.scrollTo({ top: e.offsetTop - 20, behavior: "smooth" });
                }
              }, 50),
              window.innerWidth < 768 && toggleSidebar(!1);
          });
      }

      function initSearch() {
        let c = document.getElementById("searchInput");
        c.addEventListener("input", (c) => {
          let o = c.target.value.toLowerCase().trim();
          let e = 0;
          allNavMap.forEach((c, t) => {
            let d = document.querySelector(
              `.nav-card[data-nav-id="${t.replace(/"/g, '\\"')}"]`
            );
            if (!d) return;
            let n = d.dataset.keywords,
              l = n.includes(o);
            (d.style.display = l ? "flex" : "none"), l && e++;
          }),
            document.querySelectorAll(".category-section").forEach((c) => {
              let o = c.querySelectorAll('.nav-card[style*="display: flex"]');
              c.style.display = o.length > 0 ? "block" : "none";
            });
          let t = document.getElementById("noResults");
          o && 0 === e
            ? ((t.style.display = "block"),
              (t.innerHTML =
                '<i data-lucide="search-x" class="mx-auto h-16 w-16 text-gray-600"></i> <h3 class="mt-4 text-xl font-semibold">未找到匹配的网站</h3> <p class="mt-2 text-gray-400">请尝试使用其他关键词进行搜索。</p>'),
              lucide.createIcons())
            : (t.style.display = "none"),
            o || resetToAllNavView();
        });
      }

      function initSidebar() {
        let c = document.getElementById("menu-toggle"),
          o = document.getElementById("overlay");
        c.addEventListener("click", () => toggleSidebar()),
          o.addEventListener("click", () => toggleSidebar(!1));
      }

      function toggleSidebar(c) {
        let o = document.getElementById("sidebar"),
          e = document.getElementById("overlay"),
          t = void 0 !== c ? c : o.classList.contains("-translate-x-full");
        t
          ? (o.classList.remove("-translate-x-full"),
            e.classList.remove("hidden"))
          : (o.classList.add("-translate-x-full"), e.classList.add("hidden"));
      }

      let scrollSpyObserver = null;
      
      function initScrollSpy() {
        console.log("ScrollSpy: Starting initialization");
        
        // 关闭其他一级导航的辅助函数
        function collapseOtherPrimaryNavs(activeCategoryName) {
          // 获取所有一级导航链接
          const allPrimaryLinks = document.querySelectorAll('.primary-link');
          
          allPrimaryLinks.forEach(primaryLink => {
            const categoryName = primaryLink.dataset.category;
            
            // 如果不是当前活跃的分类，则关闭它
            if (categoryName !== activeCategoryName) {
              const secondaryNav = primaryLink.parentElement.querySelector('.secondary-nav');
              const chevron = primaryLink.querySelector('[data-lucide="chevron-down"]');
              
              if (secondaryNav && !secondaryNav.classList.contains('hidden')) {
                secondaryNav.classList.add('hidden');
                if (chevron) chevron.style.transform = 'rotate(0deg)';
              }
            }
          });
        }
        
        // 延迟初始化，确保页面完全渲染
        setTimeout(() => {
          // 清理之前的观察器
          if (scrollSpyObserver) {
            console.log("ScrollSpy: Cleaning up previous observer");
            scrollSpyObserver.disconnect();
            scrollSpyObserver = null;
          }
          
          const sections = document.querySelectorAll(".category-section");
          const container = document.getElementById("home-page-container");
          
          if (!sections.length || !container) {
            console.warn("ScrollSpy: No sections or container found");
            return;
          }
          
          console.log(`ScrollSpy: Initializing with ${sections.length} sections`);
          
          scrollSpyObserver = new IntersectionObserver(
            (entries) => {
              if (container.classList.contains("hidden")) return;
              
              entries.forEach((entry) => {
                if (entry.isIntersecting) {
                  console.log(`ScrollSpy: Section ${entry.target.id} is intersecting`);
                  
                  // 清除所有高亮
                  document.querySelectorAll(".sidebar-link.active").forEach((link) => {
                    link.classList.remove("active");
                  });
                  document.querySelectorAll(".primary-link.primary-active").forEach((link) => {
                    link.classList.remove("primary-active");
                  });
                  
                  // 查找对应的导航链接
                  const targetLink = document.querySelector(
                    `.sidebar-link[href="#${entry.target.id}"]`
                  );
                  
                  if (targetLink) {
                    console.log(`ScrollSpy: Activating link for ${entry.target.id}`);
                    // 高亮当前导航链接
                    targetLink.classList.add("active");
                    
                    // 如果是二级导航，同时高亮对应的主分类
                    if (targetLink.classList.contains("secondary-link")) {
                      const categoryName = entry.target.dataset.categoryName;
                      
                      if (categoryName) {
                        const primaryLink = document.querySelector(`.primary-link[data-category="${categoryName}"]`);
                        
                        if (primaryLink) {
                          primaryLink.classList.add("primary-active");
                          
                          // 关闭其他一级导航
                          collapseOtherPrimaryNavs(categoryName);
                          
                          // 自动展开对应的二级导航
                          const secondaryNav = primaryLink.parentElement.querySelector('.secondary-nav');
                          const chevron = primaryLink.querySelector('[data-lucide="chevron-down"]');
                          if (secondaryNav && secondaryNav.classList.contains('hidden')) {
                            secondaryNav.classList.remove('hidden');
                            if (chevron) chevron.style.transform = 'rotate(180deg)';
                          }
                        }
                      }
                    }
                  } else {
                    console.warn(`ScrollSpy: No link found for section ${entry.target.id}`);
                  }
                }
              });
            },
            { 
              root: container, 
              rootMargin: "-20% 0px -70% 0px",
              threshold: 0.1
            }
          );
          
          sections.forEach((section) => {
            scrollSpyObserver.observe(section);
          });
          
          console.log("ScrollSpy: Initialization completed");
        }, 500); // 延迟500ms初始化
      }
    </script>
  </body>
</html>
